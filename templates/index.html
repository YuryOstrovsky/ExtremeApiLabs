<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extreme API Labs</title>
    <style>
        /* Styles for the button (UNCHANGED) */
        #runScriptBtn {
            display: block;
            margin: auto;
            width: 200px;
            height: 50px;
            font-size: 16px;
            background-color: #ffffff;
            color: #000000;
            border: 4px solid #6e0280;
            border-radius: 25px;
            cursor: pointer;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #runScriptBtn:hover {
            background-color: #6e0280;
            color: white;
        }

        /* Styles for centering the message (UNCHANGED) */
        #messageContainer {
            width: 50%;
            margin: auto;
            text-align: center;
            margin-top: 100px;
        }

        /* Styles for the progress bar (UNCHANGED) */
        #progressContainer {
            width: 100%;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        #progressBarContainer {
            width: 100%;
            height: 20px;
            background-color: #f3f3f3;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        #progressBarFill {
            height: 100%;
            background-color: #6e0280;
            width: 0;
            transition: width 0.3s ease-in-out;
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                color: rgba(0, 0, 0, 0);
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0),
                             .5em 0 0 rgba(0, 0, 0, 0);
            }
            40% {
                color: black;
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0),
                             .5em 0 0 rgba(0, 0, 0, 0);
            }
            60% {
                text-shadow: .25em 0 0 black, .5em 0 0 rgba(0, 0, 0, 0);
            }
            80%, 100% {
                text-shadow: .25em 0 0 black, .5em 0 0 black;
            }
        }

        /* Styles for the disclaimer (REDESIGNED — ONLY THIS BLOCK CHANGED) */
        #disclaimerContainer {
            width: min(900px, 92vw);
            margin: 100px auto 0 auto;
            padding: 28px;
            text-align: left;
            border: 1px solid rgba(2, 6, 23, 0.06);
            border-radius: 20px;
            background:
              radial-gradient(1200px 600px at 100% -10%, rgba(110,2,128,0.10), rgba(110,2,128,0) 60%),
              linear-gradient(180deg, #ffffff, #f6f7fb);
            box-shadow:
              0 2px 6px rgba(16, 24, 40, 0.06),
              0 12px 28px rgba(110, 2, 128, 0.08);
        }
        .disclaimer-header { display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
        .logo-dot { width: 12px; height: 12px; border-radius: 50%; background: #6e0280; box-shadow: 0 0 0 4px rgba(110, 2, 128, 0.15); }
        .disclaimer-title { margin: 0; font-size: clamp(24px, 2.8vw, 32px); line-height: 1.15; font-weight: 800; color: #0f172a; letter-spacing: -0.02em; }
        .disclaimer-subtitle { margin: 2px 0 18px; color: #475569; font-size: 14px; }

        .disclaimer-card {
            background: rgba(15, 23, 42, 0.55);
            color: #e2e8f0;
            border: 1px solid rgba(100, 116, 139, 0.35);
            border-radius: 16px;
            padding: 16px 18px;
            margin: 16px 0 12px;
        }
        .disclaimer-body { color: #0f172a; line-height: 1.6; font-size: 15px; margin: 0 0 14px; }

        .availability {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #faf5ff;
            border: 1px solid #e9d5ff;
            color: #4c1d95;
            padding: 10px 12px;
            border-radius: 12px;
            margin-top: 12px;
        }
        .availability .dot { width: 8px; height: 8px; border-radius: 999px; background: #6e0280; box-shadow: 0 0 0 3px rgba(110, 2, 128, 0.20); }
        .availability strong { font-weight: 800; color: #6e0280; }

        .disclaimer-links { display: grid; gap: 10px; margin-top: 12px; }
        .disclaimer-links a { text-decoration: none; font-weight: 600; }
        .link-academy { color: #2563eb; } .link-academy:hover { color: #1d4ed8; }
        .link-mail { color: #6e0280; } .link-mail:hover { color: #560166; }

        /* iframe layout (UNCHANGED) */
        #outputContainer { display: flex; }
        #jupyterIframe { width: 50%; height: 100vh; border: none; }
        #tutorialIframe { width: 50%; height: 100vh; border: none; overflow-y: auto; }
    </style>
</head>
<body>

    <!-- Disclaimer (REDESIGNED CONTENT ONLY) -->
    <div id="disclaimerContainer" role="region" aria-labelledby="disclaimerTitle">
        <div class="disclaimer-header">
            <span class="logo-dot" aria-hidden="true"></span>
            <h1 id="disclaimerTitle" class="disclaimer-title">Extreme API Lab</h1>
        </div>
        <p class="disclaimer-subtitle">Educational API Development Environment • Read before starting</p>

        <div class="disclaimer-card" role="note" aria-label="Disclaimer">
            <p class="disclaimer-body">
                This API lab is intended for educational purposes only. It is not officially supported by Extreme Networks GTAC and operates on a best-effort basis. Any usage of the lab is at the user’s own risk, and Extreme Networks does not guarantee its accuracy, reliability, or suitability for any specific purpose. Users are encouraged to exercise caution and discretion when utilizing the resources provided in this lab. Extreme Networks will not be held responsible for any consequences arising from the use of this API lab.
            </p>
            <div class="availability">
                <span class="dot" aria-hidden="true"></span>
                <div>
                    Classes are first-come, first-served with limited capacity.
                    Current number of available slots:
                    <strong><span style="font-size: 1.15em;">{{ num_available }}</span></strong>
                </div>
            </div>
            <div class="disclaimer-links">
                <div>
                    You can also sign up for the official
                    <strong>Extreme Academy API and Automation</strong> instructor-led course here:
                    <a class="link-academy" href="https://dojo.extremenetworks.com/extremecloud-iq-api-and-automation/" target="_blank" rel="noopener noreferrer">
                        Link to Extreme Academy
                    </a>
                </div>
                <div>
                    For comments or questions, email:
                    <a class="link-mail" href="mailto:PLM-Extreme-API-Labs@extremenetworks.com">Extreme API Labs</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Button (UNCHANGED) -->
    {% if not_allowed %}
        <div id="messageContainer">
            <h1>Unfortunately, we have reached our capacity for today, and no more classes are available. Please consider returning tomorrow when we can accommodate you. Classes will be available again after 4 am UTC.</h1>
            <h2>Number of classrooms taken: {{ num_containers }}</h2>
        </div>
    {% else %}
        <button id="runScriptBtn"><b>Create my own API environment</b></button>
    {% endif %}

    <!-- Progress container (UNCHANGED) -->
    <div id="progressContainer">
        <p id="progressText">Preparing environment...</p>
        <div id="progressBarContainer">
            <div id="progressBarFill"></div>
        </div>
    </div>

    <!-- Iframes (UNCHANGED: Jupyter on left, Tutorial on right) -->
    <div id="outputContainer" style="display: flex;">
        <iframe id="jupyterIframe" style="width: 50%; height: 100vh; border: none;"></iframe>
        <iframe id="tutorialIframe" style="width: 50%; height: 100vh; border: none; overflow-y: auto;"></iframe>
    </div>

    <script>
        // For APILABS<-->Studio bridging (UNCHANGED)

        document.getElementById('runScriptBtn').addEventListener('click', function() {

	     /* NEW: set a loading flag for this tab and flip the CSS state */
    sessionStorage.setItem('api_env_loading', '1');          // NEW
    document.body.classList.add('loading');                  // NEW



            // Hide the disclaimer
            document.getElementById('disclaimerContainer').style.display = 'none';

            // Hide the button
            document.getElementById('runScriptBtn').style.display = 'none';

            // Display the progress container
            document.getElementById('progressContainer').style.display = 'block';

            // Start script execution after a short delay (for demonstration purposes)
            setTimeout(function() {
                // Simulate progress by gradually increasing the width of the progress bar fill
                let progressBarFill = document.getElementById('progressBarFill');
                let width = 0;
                let interval = setInterval(function() {
                    if (width >= 100) {
                        clearInterval(interval);
                        // Change progress text to "Almost complete... Please wait until Jupyter Notebook loads, DO NOT REFRESH THIS PAGE PLEASE!"
                        document.getElementById('progressText').innerText = "Almost complete... Please wait until Jupyter Notebook loads, DO NOT REFRESH THIS PAGE PLEASE!";
                    } else {
                        width += 1;
                        progressBarFill.style.width = width + '%';
                    }
                }, 100);

                fetch('/runscript', {
                    method: 'POST'
                })
                .then(response => response.text())
                .then(output => {
                    // Removing loading bar
                    document.getElementById('progressContainer').style.display = 'none';

                    // Remove leading and trailing quotes from the URL string
                    const cleanedUrl = output.replace(/^"(.*)"$/, '$1');

                    // Set the source of the Jupyter iframe (LEFT)
                    document.getElementById('jupyterIframe').src = cleanedUrl;

                    // Once left iframe loads, we can additionally hide progress if needed
                    document.getElementById('jupyterIframe').addEventListener('load', function() {
                        document.getElementById('progressContainer').style.display = 'none';

			/* clear loading flag once the left pane is actually ready */
                sessionStorage.removeItem('api_env_loading');           // NEW
                document.body.classList.remove('loading');              // NEW

                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Hide the progress bar container if an error occurs
                    document.getElementById('progressContainer').style.display = 'none';
                    // Display an error message to the user
                    alert('An error occurred while executing the script. Please try again later.');

		   /* also clear the loading flag on error */
            sessionStorage.removeItem('api_env_loading');               // NEW
            document.body.classList.remove('loading');                  // NEW


                });

                // Load tutorial content in the RIGHT iframe (UNCHANGED)
                document.getElementById('tutorialIframe').src = 'tutorial.html';
            }, 2000);
        });

        function showPopup() {
            const lastPopupTime = localStorage.getItem('lastPopupTime');
            const now = new Date().getTime();
            // Show popup if it hasn't been shown in the last 15 minutes
            if (!lastPopupTime || (now - lastPopupTime) > 900000) {
                if (confirm("Session expired. Please refresh the page.")) {
                    location.reload();
                }
                localStorage.setItem('lastPopupTime', now);
            }
        }

        function checkTime() {
            const now = new Date();
            const utcHour = now.getUTCHours();
            const utcMinute = now.getUTCMinutes();
            const utcSecond = now.getUTCSeconds();

            if (utcHour === 4 && utcMinute === 0 && utcSecond === 0) {
                showPopup();
            }
        }

        setInterval(checkTime, 1000); // Check every second
    </script>

    <script>
      // Put the tab into a known name even if user opened API-LAB directly (UNCHANGED)
      try { window.name = 'API_LABS_TAB'; } catch (_) {}

      // Tell STUDIO (the opener) that we are ready; works cross-origin (UNCHANGED)
      try {
        if (window.opener && typeof window.opener.postMessage === 'function') {
          window.opener.postMessage('API_LAB_READY', '*');
        }
      } catch (_) {}
    </script>



<script>
  (function () {
    try {
      var params = new URLSearchParams(window.location.search);
      if (params.get('autostart') === '1') {
        // Wait for DOM & then programmatically click the existing button
        document.addEventListener('DOMContentLoaded', function () {
          var btn = document.getElementById('runScriptBtn');
          if (btn && btn.click) btn.click();
        });
      }
    } catch (e) {}
  })();
</script>

</body>
</html>

